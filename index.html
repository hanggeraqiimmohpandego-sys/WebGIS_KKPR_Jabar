<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <title>Web GIS KKPR + RTRW Provinsi Jawa Barat</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        body { margin:0; padding:0; font-family: Arial, sans-serif; }
        #map { height: 90vh; width: 100%; }
        h2 { text-align: center; margin: 10px 0; }

        /* Tombol kustom gaya Leaflet */
        .leaflet-control-custom {
            background-color: #fff;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .leaflet-control-custom:hover {
            background-color: #f4f4f4;
        }
        .leaflet-control-custom svg {
            width: 18px;
            height: 18px;
            fill: #333;
        }
    </style>
</head>
<body>
    <h2>üó∫Ô∏è Web GIS KKPR + RTRW Provinsi Jawa Barat</h2>
    <div id="map"></div>

    <script>
        const map = L.map('map').setView([-6.9, 107.6], 8);

        // üåç Basemap
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles ¬© Esri, Maxar, Earthstar Geographics'
        }).addTo(map);

        const defaultStyle = { color: "red", weight: 2, fillOpacity: 0 };
        const highlightStyle = { color: "yellow", weight: 3, fillOpacity: 0.2 };
        const overlayLayers = {}; 

        // =============================
        // 1Ô∏è‚É£ LOAD KKPR
        // =============================
        fetch("data/kkpr.json")
        .then(res => res.json())
        .then(data => {
            const kkprLayer = L.geoJSON(data, {
                style: defaultStyle,
                onEachFeature: function (feature, layer) {
                    const p = feature.properties || {};
                    const nomor = p.No_KKPR || "-";
                    const pdfLink = "lampiran/" + nomor + ".pdf";
                    const luasFormatted = p.Luas_KKPR ? `${p.Luas_KKPR} m¬≤` : "-";

                    const popup = `
                        <b>Nomor KKPR:</b> ${nomor}<br>
                        <b>Nama Pemohon:</b> ${p.Nama_Usaha || "-"}<br>
                        <b>KBLI:</b> ${p.KO_KBLI || "-"}<br>
                        <b>Luas:</b> ${luasFormatted}<br>
                        <a href="${pdfLink}" target="_blank">üìÑ Lihat Lampiran</a>
                    `;
                    layer.bindPopup(popup);
                    layer.on('click', () => { kkprLayer.resetStyle(); layer.setStyle(highlightStyle); });
                    layer.on('popupclose', () => layer.setStyle(defaultStyle));
                }
            }).addTo(map);

            overlayLayers["üìç KKPR"] = kkprLayer;
        });

        // =============================
        // 2Ô∏è‚É£ LOAD SEMUA ZIP RTRW
        // =============================
        const kabkotaFiles = [
            "RTRWP Kab Bandung Barat","RTRWP Kab Bandung","RTRWP Kab Bekasi","RTRWP Kab Bogor",
            "RTRWP Kab Ciamis","RTRWP Kab Cianjur","RTRWP Kab Cirebon","RTRWP Kab Garut",
            "RTRWP Kab Indramayu","RTRWP Kab Karawang","RTRWP Kab Kuningan","RTRWP Kab Majalengka",
            "RTRWP Kab Pangandaran","RTRWP Kab Purwakarta","RTRWP Kab Subang","RTRWP Kab Sumedang",
            "RTRWP Kab Tasikmalaya","RTRWP Kota Bandung","RTRWP Kota Banjar","RTRWP Kota Bekasi",
            "RTRWP Kota Bogor","RTRWP Kota Cimahi","RTRWP Kota Cirebon","RTRWP Kota Depok",
            "RTRWP Kota Sukabumi","RTRWP Kota Tasikmalaya"
        ];

        const colors = [
            "#00FF00","#00FFFF","#FF00FF","#FFA500","#8A2BE2","#1E90FF","#FFD700",
            "#DC143C","#00CED1","#FF69B4","#ADFF2F","#CD5C5C","#DAA520","#7FFFD4",
            "#FF6347","#90EE90","#EE82EE","#B0C4DE","#4682B4","#008B8B","#A0522D",
            "#9370DB","#FFB6C1","#C0C0C0","#D2691E","#2E8B57"
        ];

        const layerControl = L.control.layers(null, overlayLayers, { collapsed: true }).addTo(map);

        async function loadGeoJSONFromZip(url, kabkota, color) {
            try {
                const resp = await fetch(url);
                const blob = await resp.blob();
                const zip = await JSZip.loadAsync(blob);
                const files = Object.keys(zip.files).filter(f => f.endsWith(".json") || f.endsWith(".geojson"));

                for (const name of files) {
                    const text = await zip.file(name).async("string");
                    const geojson = JSON.parse(text);

                    const rtrwLayer = L.geoJSON(geojson, {
                        style: { color: color, weight: 1, fillOpacity: 0.05 },
                        onEachFeature: (f, l) => l.bindPopup(`<b>${kabkota}</b><br>${name}`)
                    });

                    overlayLayers[kabkota] = rtrwLayer;
                    layerControl.addOverlay(rtrwLayer, kabkota);

                    // ‚úÖ Zoom otomatis saat layer dinyalakan
                    map.on('overlayadd', function(e) {
                        if (e.name === kabkota) {
                            const bounds = rtrwLayer.getBounds();
                            if (bounds.isValid()) map.fitBounds(bounds, { padding: [30, 30] });
                        }
                    });

                    console.log(`‚úÖ Loaded ${name} from ${kabkota}`);
                }
            } catch (err) {
                console.error(`‚ùå Gagal load ${kabkota}:`, err);
            }
        }

        kabkotaFiles.forEach((nama, i) => {
            const path = `data/${nama}.zip`;
            loadGeoJSONFromZip(path, nama, colors[i % colors.length]);
        });

        // =============================
        // 3Ô∏è‚É£ Tombol ‚ÄúHome‚Äù Reset Jawa Barat
        // =============================
        const homeControl = L.control({ position: 'topleft' });
        homeControl.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'leaflet-control-custom leaflet-bar');
            div.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                    <path d="M10 2L2 9h2v9h4v-5h4v5h4V9h2L10 2z"/>
                </svg>
            `;
            div.title = "Kembali ke tampilan Jawa Barat";
            div.onclick = () => map.setView([-6.9, 107.6], 8);
            return div;
        };
        homeControl.addTo(map);
    </script>
</body>
</html>
