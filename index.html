<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Web GIS KKPR & RTRW Jawa Barat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; padding:0; font-family:"Segoe UI", Arial, sans-serif; }
    #map { height:100vh; width:100%; }
    h2 { position:absolute; top:10px; left:15px; background:rgba(255,255,255,0.8); padding:6px 14px; border-radius:10px; z-index:900; font-weight:bold; }
    .layer-toggle { position:absolute; top:70px; left:15px; z-index:1000; background:rgba(255,255,255,0.8); border-radius:10px; padding:8px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2); backdrop-filter: blur(6px); }
    .layer-toggle:hover { background: rgba(255,255,255,0.9);}
    .layer-icon { width:20px; height:16px; position:relative; }
    .layer-icon div { width:100%; height:4px; background:#d00; position:absolute; transform: skewX(-25deg); border-radius:2px; }
    .layer-icon div:nth-child(1) { top:0; }
    .layer-icon div:nth-child(2) { top:6px; }
    .layer-icon div:nth-child(3) { top:12px; }
    .layer-panel {
      position:absolute; top:110px; left:15px; z-index:999; background:rgba(255,255,255,0.15);
      backdrop-filter: blur(10px); border-radius:12px; padding:10px 15px; box-shadow:0 4px 15px rgba(0,0,0,0.3);
      color:white; width:260px; font-size:14px; max-height: calc(100vh - 130px);
      display:flex; flex-direction:column; gap:8px; opacity:0; transform:translateY(-10px); pointer-events:none;
      transition: all 0.4s ease;
    }
    .layer-panel.show { opacity:1; transform:translateY(0); pointer-events:auto; }
    .layer-panel label { display:block; margin-bottom:8px; cursor:pointer; }
    .layer-panel input[type="checkbox"] { margin-right:6px; }
    .transparency-control { width:100%; margin-bottom:10px; }
    #rtrwLayerList { overflow-y: auto; padding-right: 6px; max-height: calc(100vh - 260px); }
    #rtrwLayerList label { color: #fff; display:block; margin-bottom:6px; }
    #rtrwLayerList input[type="range"] { width:100%; margin-bottom:10px; }
    #rtrwLayerList::-webkit-scrollbar { width:10px; }
    #rtrwLayerList::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.25); border-radius:6px; }
    .kbli-link { color: #0078ff; font-size: 12px; text-decoration: none; margin-left: 5px; }
    .kbli-link:hover { text-decoration: underline; }
    table { border-collapse: collapse; width: 100%; font-size: 13px; }
    td { padding: 3px 5px; vertical-align: top; }
    .zone-title { font-weight:bold; color:#d00; margin-top:6px; }
    .zone-section { margin-bottom:6px; }
    #shpUploadContainer { position:absolute; top:400px; left:15px; z-index:1000; background:rgba(255,255,255,0.8); padding:8px; border-radius:10px; }
    #saveShpBtn { display:none; margin-top:6px; padding:4px 8px; background:#0078ff; color:white; border:none; border-radius:4px; cursor:pointer; }
    #saveShpBtn:hover { background:#005bbb; }
  </style>
</head>
<body>
<h2>Web GIS KKPR & RTRW Jawa Barat</h2>
<div id="map"></div>

<div class="layer-toggle" id="layerToggle">
  <div class="layer-icon"><div></div><div></div><div></div></div>
</div>

<div class="layer-panel" id="layerPanel">
  <label><input type="checkbox" id="osmLayer" checked> Basemap: OpenStreetMap</label>
  <label><input type="checkbox" id="satLayer" checked> Basemap: Citra Satelit</label>
  <label><input type="checkbox" id="kkprLayer" checked> Layer KKPR</label>
  <hr>
  <div id="rtrwLayerList"></div>
</div>

<div id="shpUploadContainer">
  <label><b>Upload Shapefile (ZIP): </b></label>
  <input type="file" id="shpUpload" accept=".zip" />
  <button id="saveShpBtn">ðŸ’¾ Simpan ke Drive</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="style/rtrw_style.js"></script>
<script src="style/rtrwZoningInfo.js"></script>

<script>
const map = L.map('map').setView([-6.9, 107.6], 8);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap' }).addTo(map);
const satelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'Â© Esri, Maxar' }).addTo(map);

const kkprLayer = L.layerGroup().addTo(map);
const rtrwLayers = {};
let allKKPR = [];
let currentHighlight = null;

// ===== Load KKPR =====
fetch("data/kkpr.json").then(r=>r.json()).then(data=>{
  L.geoJSON(data, {
    style: { color:"red", weight:2, fillOpacity:0 },
    onEachFeature: (feature, layer)=>{ layer.kkprData = feature.properties; allKKPR.push(layer); }
  }).addTo(kkprLayer);
});

// ===== Load RTRW =====
async function loadRTRW(zipPath, kabName){
  try{
    const resp = await fetch(zipPath);
    const blob = await resp.blob();
    const zip = await JSZip.loadAsync(blob);
    const fileName = Object.keys(zip.files).find(f=>f.endsWith(".json")||f.endsWith(".geojson"));
    if(!fileName) return;
    const content = await zip.files[fileName].async("string");
    const data = JSON.parse(content);

    const layer = L.geoJSON(data, {
      style: f=>({ color: rtrwStyleByNama[f.properties?.NAMOBJ]||"#FF0000", weight:1, fillOpacity:0.5 }),
      onEachFeature: (feature, lyr)=>{
        const name = feature.properties?.NAMOBJ||"-";
        lyr.on('click', e=>{
          const zoneInfo = rtrwZoningInfo[name];
          let html = `<div class="zone-title">${name}</div>`;
          if(zoneInfo){
            html += ['allowed','conditional','forbidden'].map(k=>{
              const arr = zoneInfo[k]; if(!arr||arr.length===0) return '';
              return `<div class="zone-section"><b>${k.charAt(0).toUpperCase()+k.slice(1)}:</b><ul>${arr.map(a=>`<li>${a}</li>`).join('')}</ul></div>`;
            }).join('');
          } else { html += "<i>Informasi zona tidak tersedia</i>"; }
          L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
        });
      }
    }).addTo(map);

    rtrwLayers[kabName] = layer;
    const div = document.getElementById("rtrwLayerList");
    const id = kabName.replace(/\s/g,"");
    div.insertAdjacentHTML("beforeend", `<label><input type="checkbox" id="${id}" checked> RTRW: ${kabName}</label>
      <input type="range" id="${id}_opacity" min="0" max="1" step="0.05" value="0.5" class="transparency-control">`);
    document.getElementById(id).addEventListener("change", e=> e.target.checked ? map.addLayer(layer) : map.removeLayer(layer));
    document.getElementById(id+"_opacity").addEventListener("input", e=> layer.setStyle({fillOpacity: parseFloat(e.target.value)}));
  } catch(err){ console.error("Gagal load RTRW:", kabName, err); }
}

// ===== Layer Toggle =====
const toggleBtn = document.getElementById('layerToggle');
const panel = document.getElementById('layerPanel');
toggleBtn.addEventListener('click', ()=> panel.classList.toggle('show'));
document.getElementById('osmLayer').addEventListener('change', e=> e.target.checked ? map.addLayer(osm) : map.removeLayer(osm));
document.getElementById('satLayer').addEventListener('change', e=> e.target.checked ? map.addLayer(satelit) : map.removeLayer(satelit));
document.getElementById('kkprLayer').addEventListener('change', e=> e.target.checked ? map.addLayer(kkprLayer) : map.removeLayer(kkprLayer));

// ===== Map Click KKPR =====
map.on('click', function(e){
  const latlng = e.latlng;
  const hits = allKKPR.filter(l=>l.getBounds().contains(latlng));
  if(hits.length===0) return;

  let html = "<b>Daftar KKPR di lokasi ini:</b><br><ul>";
  hits.forEach((l,i)=> html+=`<li><a href="#" onclick="selectKKPR(${i});return false;">${l.kkprData.No_KKPR}</a></li>`);
  html+="</ul>";
  L.popup().setLatLng(latlng).setContent(html).openOn(map);

  window.selectKKPR = function(index){
    const layer = hits[index];
    if(currentHighlight) currentHighlight.setStyle({color:"red"});
    layer.setStyle({color:"yellow"}); currentHighlight=layer; layer.bringToFront();
    const p=layer.kkprData;
    const luas=p.Luas_KKPR?p.Luas_KKPR+" mÂ²":"-";
    const pdf=`lampiran/${p.No_KKPR}.pdf`;
    const popup = `<table>
      <tr><td>Nomor KKPR</td><td>${p.No_KKPR||"-"}</td></tr>
      <tr><td>Nama Pemohon</td><td>${p.Nama_Usaha||"-"}</td></tr>
      <tr><td>Kode KBLI</td><td>${p.KO_KBLI||"-"} <a href="https://oss.go.id/id/kbli" target="_blank" class="kbli-link">(Lihat OSS)</a></td></tr>
      <tr><td>Alamat</td><td>${p.Alamat||"-"}</td></tr>
      <tr><td>Desa/Kelurahan</td><td>${p.Desa_Kel||"-"}</td></tr>
      <tr><td>Kecamatan</td><td>${p.Kec||"-"}</td></tr>
      <tr><td>Kota/Kabupaten</td><td>${p.KoKab||"-"}</td></tr>
      <tr><td>Jenis KKPR</td><td>${p.Jns_KKPR||"-"}</td></tr>
      <tr><td>Penerbit</td><td>${p.Penerbit||"-"}</td></tr>
      <tr><td>Tanggal Terbit</td><td>${p.Tagl_Terbi||"-"}</td></tr>
      <tr><td>Dasar Penerbitan</td><td>${p.Ket_KKPR||"-"}</td></tr>
      <tr><td>Luas Dokumen</td><td>${luas}</td></tr>
    </table><br><a href="${pdf}" target="_blank">ðŸ“„ Lihat Lampiran PDF</a>`;
    L.popup().setLatLng(latlng).setContent(popup).openOn(map);
  };
});

// ===== Load RTRW Files =====
const kabFiles = [
  "RTRWP Kab Bandung.zip","RTRWP Kab Bogor.zip","RTRWP Kab Bekasi.zip",
  "RTRWP Kab Purwakarta.zip","RTRWP Kab Karawang.zip","RTRWP Kab Subang.zip",
  "RTRWP Kab Bandung Barat.zip","RTRWP Kab Cianjur.zip","RTRWP Kab Cirebon.zip",
  "RTRWP Kab Indramayu.zip","RTRWP Kab Majalengka.zip","RTRWP Kab Kuningan.zip",
  "RTRWP Kab Sumedang.zip","RTRWP Kota Bandung.zip","RTRWP Kota Cirebon.zip",
  "RTRWP Kota Cimahi.zip"
];
kabFiles.forEach(f=>{ const k=f.replace("RTRWP ","").replace(".zip",""); loadRTRW("data/"+f, k); });

// ===== Upload SHP + Save =====
const uploadedLayers = L.layerGroup().addTo(map);
const saveBtn = document.getElementById('saveShpBtn');
let uploadedFile = null;

document.getElementById('shpUpload').addEventListener('change', async e=>{
  const file = e.target.files[0]; if(!file) return; uploadedFile = file;

  const reader = new FileReader();
  reader.onload = async evt=>{
    try{
      const geojson = await shp(evt.target.result);
      uploadedLayers.clearLayers();
      const layer = L.geoJSON(geojson, {
        style:{color:'blue',weight:2,fillOpacity:0.3},
        onEachFeature:(f,l)=>{
          l.on('click', e=>{
            const shpHtml = "<b>Data SHP:</b><br>"+Object.entries(f.properties||{}).map(([k,v])=>`${k}: ${v}`).join("<br>");
            const kkprHits = allKKPR.filter(k=>turf.booleanOverlap(k.toGeoJSON().geometry, l.toGeoJSON().geometry) ||
              turf.booleanContains(k.toGeoJSON().geometry, l.toGeoJSON().geometry) ||
              turf.booleanContains(l.toGeoJSON().geometry, k.toGeoJSON().geometry));
            const kkprHtml = kkprHits.length>0?"<b>KKPR bertampalan:</b><br>"+kkprHits.map(k=>`- ${k.kkprData.No_KKPR} (${k.kkprData.Nama_Usaha})`).join("<br>"):"Tidak bertampalan dengan KKPR.<br>";
            let rtrwZones=[];
            Object.values(rtrwLayers).forEach(rL=>rL.eachLayer(r=>{ const rg=r.toGeoJSON(); if(turf.booleanOverlap(rg.geometry,l.toGeoJSON().geometry)||turf.booleanContains(rg.geometry,l.toGeoJSON().geometry)||turf.booleanContains(l.toGeoJSON().geometry,rg.geometry)) rtrwZones.push(r.feature?.properties?.NAMOBJ||"-"); }));
            const rtrwHtml="<b>Zona RTRW bertumpang:</b> "+(rtrwZones.length?rtrwZones.join(", "):"Tidak ada");
            L.popup().setLatLng(e.latlng).setContent(shpHtml+"<hr>"+kkprHtml+"<hr>"+rtrwHtml).openOn(map);
          });
        }
      }).addTo(uploadedLayers);
      map.fitBounds(layer.getBounds());
      alert("Shapefile berhasil ditampilkan! Klik fitur untuk melihat analisis KKPR & RTRW.");
      saveBtn.style.display="inline-block";
    } catch(err){ console.error(err); alert("Gagal membaca Shapefile. Pastikan ZIP berisi .shp, .shx, .dbf (dan opsional .prj)"); }
  };
  reader.readAsArrayBuffer(file);
});

// ===== Save ke Google Drive =====
saveBtn.addEventListener('click', ()=>{
  if(!uploadedFile){ alert("Tidak ada file untuk disimpan."); return; }
  if(google && google.script && google.script.run){
    google.script.run.withSuccessHandler(msg=>alert("Berhasil disimpan di Drive: "+msg))
                     .withFailureHandler(err=>alert("Gagal menyimpan: "+err))
                     .saveFileToDrive(uploadedFile);
  } else { alert("Google Script tidak tersedia."); }
});
</script>
</body>
</html>
