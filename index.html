<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Web GIS KKPR + RTRW</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { margin:0; padding:0; font-family:"Segoe UI",Arial,sans-serif; }
  #map { height:100vh; width:100%; }
  h2 {
    text-align:center; position:absolute; top:10px; left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.8); padding:6px 14px; border-radius:10px;
    z-index:900; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,0.2);
  }
  .layer-toggle {
    position:absolute; top:70px; left:15px; z-index:1000;
    background:rgba(255,255,255,0.8); border-radius:10px; padding:8px;
    cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2); backdrop-filter:blur(6px);
    transition: background 0.3s;
  }
  .layer-toggle:hover { background: rgba(255,255,255,0.9); }
  .layer-icon { width:20px; height:16px; position:relative; }
  .layer-icon div { width:100%; height:4px; background:#d00; position:absolute; transform: skewX(-25deg); border-radius:2px; }
  .layer-icon div:nth-child(1){top:0;} .layer-icon div:nth-child(2){top:6px;} .layer-icon div:nth-child(3){top:12px;}
  .layer-panel {
    position:absolute; top:110px; left:15px; z-index:999;
    background: rgba(255,255,255,0.15); backdrop-filter:blur(10px);
    border-radius:12px; padding:10px 15px; box-shadow:0 4px 15px rgba(0,0,0,0.3);
    color:white; width:250px; font-size:14px;
    opacity:0; transform:translateY(-10px); pointer-events:none; transition:all 0.4s ease;
  }
  .layer-panel.show { opacity:1; transform:translateY(0); pointer-events:auto; }
  .layer-panel label { display:block; margin-bottom:8px; cursor:pointer; }
  .layer-panel input { margin-right:6px; }
  .slider-container { display:flex; align-items:center; margin-top:8px; }
  .slider-container input { flex:1; }
  .slider-container span { margin-left:6px; }
  /* Tabel popup responsive */
  .popup-table { border-collapse:collapse; width:100%; font-size:13px; }
  .popup-table td, .popup-table th { border:1px solid #555; padding:3px; }
  .kkpr-tab-title { cursor:pointer; color:#0066cc; display:block; margin-bottom:2px; }
</style>
</head>
<body>
<h2>Web GIS KKPR + RTRW</h2>
<div id="map"></div>

<div class="layer-toggle" id="layerToggle">
  <div class="layer-icon"><div></div><div></div><div></div></div>
</div>

<div class="layer-panel" id="layerPanel">
  <label><input type="checkbox" id="osmLayer" checked> Basemap: OpenStreetMap</label>
  <label><input type="checkbox" id="satLayer" checked> Basemap: Citra Satelit</label>
  <label><input type="checkbox" id="kkprLayer" checked> Layer KKPR</label>
  <label><input type="checkbox" id="rtrwLayer" checked> Layer RTRW</label>
  <div class="slider-container">
    <label for="rtrwOpacity">Transparency RTRW</label>
    <input type="range" id="rtrwOpacity" min="0" max="100" value="20">
    <span id="rtrwValue">20%</span>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([-6.9, 107.6], 9);

// Basemap
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
const satelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'&copy; Esri, Maxar, Earthstar Geographics'}).addTo(map);

// Layer KKPR
const kkprLayer = L.layerGroup();
let highlightedLayers = [];

// Multi-KKPR overlap popup
function createMultiPopup(features, latlng) {
  let tabsHtml = '<div style="max-height:300px; overflow:auto;">';
  features.forEach((feature, idx) => {
    const p = feature.properties;
    const nomor = p.No_KKPR || "-";
    const pdfLink = "lampiran/" + nomor + ".pdf";
    const luas = p.Luas_KKPR ? `${p.Luas_KKPR} mÂ²` : "-";
    tabsHtml += `
      <span class="kkpr-tab-title" onclick="zoomToKKPR(${idx})">Nomor KKPR: ${p.No_KKPR || "-"}</span>
      <div id="kkpr-tab-${idx}" style="display:none; margin-bottom:5px;">
        <table class="popup-table">
          <tr><td>Nomor KKPR</td><td>${p.No_KKPR || "-"}</td></tr>
          <tr><td>Nama Pemohon</td><td>${p.Nama_Usaha || "-"}</td></tr>
          <tr><td>Kode KBLI</td><td>${p.KO_KBLI || "-"}</td></tr>
          <tr><td>Alamat</td><td>${p.Alamat || "-"}</td></tr>
          <tr><td>Desa/Kelurahan</td><td>${p.Desa_Kel || "-"}</td></tr>
          <tr><td>Kecamatan</td><td>${p.Kec || "-"}</td></tr>
          <tr><td>Kota/Kabupaten</td><td>${p.KoKab || "-"}</td></tr>
          <tr><td>Jenis KKPR yang Diterbitkan</td><td>${p.Jns_KKPR || "-"}</td></tr>
          <tr><td>Penerbit KKPR</td><td>${p.Penerbit || "-"}</td></tr>
          <tr><td>Tanggal Terbit Dokumen KKPR</td><td>${p.Tagl_Terbi || "-"}</td></tr>
          <tr><td>Dasar Pertimbangan Penerbitan KKPR</td><td>${p.Ket_KKPR || "-"}</td></tr>
          <tr><td>Luas KKPR berdasarkan Dokumen</td><td>${luas}</td></tr>
          <tr><td colspan="2" style="text-align:center;padding-top:6px;">
            <a href="${pdfLink}" target="_blank">ðŸ“„ Lihat Lampiran PDF</a>
          </td></tr>
        </table>
      </div>
    `;
  });
  tabsHtml += '</div>';
  const popup = L.popup({ maxWidth:350 }).setLatLng(latlng).setContent(tabsHtml).openOn(map);

  window.zoomToKKPR = function(idx) {
    const layer = features[idx].__leafletLayer;
    // Reset previous highlights
    highlightedLayers.forEach(l=>l.setStyle({color:"red"}));
    highlightedLayers = [];
    layer.setStyle({ color:"yellow" });
    highlightedLayers.push(layer);
    map.fitBounds(layer.getBounds());
    features.forEach((f,i)=>{
      document.getElementById(`kkpr-tab-${i}`).style.display = (i===idx)?"block":"none";
    });
  }
}

fetch("data/kkpr.json")
  .then(res => res.json())
  .then(data=>{
    const geoLayer = L.geoJSON(data,{
      style:{ color:"red", weight:2, fillOpacity:0 },
      onEachFeature:function(feature,layer){ feature.__leafletLayer = layer; }
    }).addTo(kkprLayer);
    kkprLayer.addTo(map);

    map.on('click',function(e){
      const clickedFeatures = [];
      geoLayer.eachLayer(layer=>{
        if(layer.getBounds && layer.getBounds().contains(e.latlng)) clickedFeatures.push(layer.feature);
      });
      if(clickedFeatures.length>0) createMultiPopup(clickedFeatures,e.latlng);
    });
  });

// Layer RTRW
const rtrwLayers = [];
const rtrwFiles = [
  {file:"data/Kawasan yang Memberikan Perlindungan terhadap Kawasan Bawahannya.json", color:"rgb(35,65,40)"},
  {file:"data/Kawasan Transportasi.json", color:"rgb(215,55,0)"},
  {file:"data/Kawasan Peruntukan Industri.json", color:"rgb(105,0,0)"}
];
rtrwFiles.forEach(r=>{
  fetch(r.file).then(res=>res.json()).then(data=>{
    const layer = L.geoJSON(data,{ style: { color: r.color, fillColor: r.color, fillOpacity:0.2 } }).addTo(map);
    rtrwLayers.push(layer);
  });
});

// Filter toggle
document.getElementById('layerToggle').addEventListener('click',()=>{ document.getElementById('layerPanel').classList.toggle('show'); });
document.getElementById('osmLayer').addEventListener('change',e=>{ e.target.checked?map.addLayer(osm):map.removeLayer(osm); });
document.getElementById('satLayer').addEventListener('change',e=>{ e.target.checked?map.addLayer(satelit):map.removeLayer(satelit); });
document.getElementById('kkprLayer').addEventListener('change',e=>{ e.target.checked?map.addLayer(kkprLayer):map.removeLayer(kkprLayer); });
document.getElementById('rtrwLayer').addEventListener('change',e=>{
  rtrwLayers.forEach(l=>{ e.target.checked?map.addLayer(l):map.removeLayer(l); });
});

// RTRW transparency slider
const rtrwSlider = document.getElementById('rtrwOpacity');
const rtrwValue = document.getElementById('rtrwValue');
rtrwSlider.addEventListener('input', e=>{
  const val = e.target.value/100;
  rtrwValue.innerText = e.target.value + "%";
  rtrwLayers.forEach(l=>{
    l.setStyle({ fillOpacity: val });
  });
});
</script>
</body>
</html>
