<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebGIS KKPR & RTRW Jawa Barat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    /* Panel kontrol di kiri */
    #layer-control {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 300px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      font-family: Arial, sans-serif;
    }

    /* Bagian daftar RTRW scrollable */
    #rtrw-list {
      max-height: 75vh; /* Biar tidak terlalu panjang */
      overflow-y: auto;
      padding-right: 5px;
    }

    /* Styling checkbox dan slider */
    .layer-item {
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid #ddd;
    }

    input[type="range"] {
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Panel Layer -->
  <div id="layer-control">
    <h3>üìç Layer Control</h3>

    <label>
      <input type="checkbox" id="kkprLayer" checked />
      <b>Data KKPR</b>
    </label>

    <hr>

    <div id="rtrw-list">
      <!-- RTRW per kab/kota akan ditambahkan otomatis via JS -->
    </div>
  </div>

  <script>
    // --- Peta dasar ---
    const map = L.map("map").setView([-6.9, 107.6], 9);

    const satellite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        attribution: "¬© Esri, Maxar",
      }
    ).addTo(map);

    // --- Style simbolisasi berdasarkan NAMOBJ ---
    const styleRTRW = (namobj) => {
      const colors = {
        "Badan Air": [151, 219, 242],
        "Kawasan Cagar Budaya": [255, 55, 205],
        "Kawasan Hutan Adat": [5, 105, 40],
        "Kawasan Hutan Produksi": [0, 155, 55],
        "Kawasan Konservasi": [120, 60, 205],
        "Kawasan Lindung Geologi": [120, 135, 130],
        "Kawasan Pariwisata": [255, 165, 255],
        "Kawasan Pembuangan Hasil Pengerukan di Laut": [215, 190, 155],
        "Kawasan Pencadangan Konservasi di Laut": [90, 150, 150],
        "Kawasan Pergaraman": [180, 150, 120],
        "Kawasan Perikanan": [80, 125, 210],
        "Kawasan Perlindungan Setempat": [5, 215, 215],
        "Kawasan Permukiman": [255, 125, 0],
        "Kawasan Pertahanan dan Keamanan": [155, 0, 255],
        "Kawasan Pertambangan dan Energi": [5, 25, 55],
        "Kawasan Pertanian": [200, 200, 60],
        "Kawasan Peruntukan Industri": [105, 0, 0],
        "Kawasan Transportasi": [215, 55, 0],
        "Kawasan yang Memberikan Perlindungan terhadap Kawasan Bawahannya": [35, 65, 40],
      };
      const c = colors[namobj] || [150, 150, 150];
      return { color: `rgb(${c[0]},${c[1]},${c[2]})`, weight: 1, fillOpacity: 0.5 };
    };

    // --- Layer KKPR ---
    let kkprLayer;
    fetch("data/kkpr.json")
      .then((res) => res.json())
      .then((data) => {
        kkprLayer = L.geoJSON(data, {
          pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 6, color: "red" }),
          onEachFeature: (feature, layer) => {
            const props = feature.properties;
            const popup = `
              <b>Nomor KKPR:</b> ${props.no_kkpr || "-"}<br>
              <b>Nama Pemohon:</b> ${props.nama_pemohon || "-"}<br>
              <b>Luas:</b> ${props.luas || "-"} m¬≤<br>
              <b>Peruntukan:</b> ${props.peruntukan || "-"}
            `;
            layer.bindPopup(popup);
          },
        }).addTo(map);
      });

    document.getElementById("kkprLayer").addEventListener("change", (e) => {
      if (kkprLayer) {
        if (e.target.checked) map.addLayer(kkprLayer);
        else map.removeLayer(kkprLayer);
      }
    });

    // --- Daftar RTRW kab/kota yang mau ditambahkan ---
    const kabkotaList = [
      "RTRWP Kab Purwakarta",
      "RTRWP Kab Karawang",
      "RTRWP Kab Subang",
      "RTRWP Kab Bandung Barat",
      "RTRWP Kab Cianjur",
      "RTRWP Kab Cirebon",
      "RTRWP Kab Indramayu",
      "RTRWP Kab Majalengka",
      "RTRWP Kab Kuningan",
      "RTRWP Kab Sumedang",
      "RTRWP Kota Bandung",
      "RTRWP Kota Cirebon",
      "RTRWP Kota Cimahi"
    ];

    const rtrwLayers = {};
    const rtrwContainer = document.getElementById("rtrw-list");

    kabkotaList.forEach((kab) => {
      // Buat elemen kontrol per kabupaten
      const div = document.createElement("div");
      div.className = "layer-item";

      const id = kab.replace(/\s+/g, "_");
      div.innerHTML = `
        <label>
          <input type="checkbox" id="${id}" />
          <b>${kab}</b>
        </label>
        <input type="range" id="${id}_opacity" min="0" max="1" step="0.1" value="0.8">
      `;

      rtrwContainer.appendChild(div);

      // Load shapefile dari ZIP
      const zipPath = `data/${kab}.zip`;
      shp(zipPath).then((geojson) => {
        const layer = L.geoJSON(geojson, {
          style: (f) => styleRTRW(f.properties.NAMOBJ),
          onEachFeature: (feature, layer) => {
            layer.bindPopup(`<b>Jenis:</b> ${feature.properties.NAMOBJ || "-"}<br><b>Kab/Kota:</b> ${kab}`);
          },
        });
        rtrwLayers[kab] = layer;
      });

      // Checkbox event
      div.querySelector(`#${id}`).addEventListener("change", (e) => {
        const layer = rtrwLayers[kab];
        if (!layer) return;
        if (e.target.checked) layer.addTo(map);
        else map.removeLayer(layer);
      });

      // Slider opacity event
      div.querySelector(`#${id}_opacity`).addEventListener("input", (e) => {
        const layer = rtrwLayers[kab];
        if (layer)
          layer.setStyle({ fillOpacity: e.target.value });
      });
    });
  </script>
</body>
</html>
