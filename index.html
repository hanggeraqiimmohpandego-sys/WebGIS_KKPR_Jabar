<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Web GIS KKPR + RTRW</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; padding:0; font-family:"Segoe UI", Arial, sans-serif; }
    #map { height:100vh; width:100%; }

    h2 {
      text-align:center;
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      background: rgba(255,255,255,0.8);
      padding:6px 14px;
      border-radius:10px;
      z-index:900;
      font-weight:bold;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }

    .layer-toggle { position:absolute; top:70px; left:15px; z-index:1000; background: rgba(255,255,255,0.8); border-radius:10px; padding:8px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2); backdrop-filter:blur(6px); transition:background 0.3s; }
    .layer-toggle:hover { background: rgba(255,255,255,0.9); }
    .layer-icon { width:20px; height:16px; position:relative; }
    .layer-icon div { width:100%; height:4px; background:#d00; position:absolute; transform:skewX(-25deg); border-radius:2px; }
    .layer-icon div:nth-child(1){top:0;} .layer-icon div:nth-child(2){top:6px;} .layer-icon div:nth-child(3){top:12px;}

    .layer-panel { position:absolute; top:110px; left:15px; z-index:999; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius:12px; padding:10px 15px; box-shadow:0 4px 15px rgba(0,0,0,0.3); color:white; width:250px; font-size:14px; opacity:0; transform:translateY(-10px); pointer-events:none; transition: all 0.4s ease; }
    .layer-panel.show { opacity:1; transform:translateY(0); pointer-events:auto; }
    .layer-panel label { display:block; margin-bottom:8px; cursor:pointer; }
    .layer-panel input { margin-right:6px; }

    .popup-table { border-collapse: collapse; width: 100%; font-size: 13px; }
    .popup-table td, .popup-table th { border: 1px solid #888; padding: 4px 6px; }
    .popup-table th { background-color: #f0f0f0; }
  </style>
</head>
<body>
  <h2>Web GIS KKPR + RTRW</h2>
  <div id="map"></div>

  <div class="layer-toggle" id="layerToggle">
    <div class="layer-icon"><div></div><div></div><div></div></div>
  </div>

  <div class="layer-panel" id="layerPanel">
    <label><input type="checkbox" id="osmLayer" checked> Basemap: OpenStreetMap</label>
    <label><input type="checkbox" id="satLayer" checked> Basemap: Citra Satelit</label>
    <label><input type="checkbox" id="kkprLayer" checked> Layer KKPR</label>
    <hr style="border-color:white;">
    <label><input type="checkbox" id="perlindunganLayer" checked> Kawasan Perlindungan</label>
    <label><input type="checkbox" id="transportasiLayer" checked> Kawasan Transportasi</label>
    <label><input type="checkbox" id="industriLayer" checked> Kawasan Industri</label>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-6.9, 107.6], 9);

    // Basemap
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const satelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'&copy; Esri, Maxar, Earthstar Geographics' }).addTo(map);

    // Buat pane
    map.createPane('rtrwPane');
    map.getPane('rtrwPane').style.zIndex = 600;
    map.getPane('rtrwPane').style.pointerEvents = 'auto';

    map.createPane('kkprPane');
    map.getPane('kkprPane').style.zIndex = 650;
    map.getPane('kkprPane').style.pointerEvents = 'auto';

    // KKPR Layer
    const kkprLayer = L.layerGroup();
    fetch("data/kkpr.json").then(r=>r.json()).then(data=>{
      L.geoJSON(data,{
        pane: 'kkprPane',
        style:{ color:"red", weight:2, fillOpacity:0 },
        onEachFeature: (feature, layer)=>{
          const p = feature.properties;
          const pdfLink = "lampiran/" + (p.No_KKPR||"-") + ".pdf";
          const luas = p.Luas_KKPR ? `${p.Luas_KKPR} mÂ²` : "-";
          const popupContent = `
            <table class="popup-table">
              <tr><th>Nomor KKPR</th><td>${p.No_KKPR||"-"}</td></tr>
              <tr><th>Nama Pemohon</th><td>${p.Nama_Usaha||"-"}</td></tr>
              <tr><th>Kode KBLI</th><td>${p.KO_KBLI||"-"} <a href="https://oss.go.id/id/kbli" target="_blank" style="color:cyan;">(Cek KBLI)</a></td></tr>
              <tr><th>Alamat</th><td>${p.Alamat||"-"}</td></tr>
              <tr><th>Desa/Kelurahan</th><td>${p.Desa_Kel||"-"}</td></tr>
              <tr><th>Kecamatan</th><td>${p.Kec||"-"}</td></tr>
              <tr><th>Kota/Kabupaten</th><td>${p.KoKab||"-"}</td></tr>
              <tr><th>Jenis KKPR</th><td>${p.Jns_KKPR||"-"}</td></tr>
              <tr><th>Penerbit</th><td>${p.Penerbit||"-"}</td></tr>
              <tr><th>Tanggal Terbit</th><td>${p.Tagl_Terbi||"-"}</td></tr>
              <tr><th>Dasar Pertimbangan</th><td>${p.Ket_KKPR||"-"}</td></tr>
              <tr><th>Luas</th><td>${luas}</td></tr>
              <tr><td colspan="2" style="text-align:center;padding-top:6px;">
                <a href="${pdfLink}" target="_blank">ðŸ“„ Lihat Lampiran PDF</a>
              </td></tr>
            </table>
          `;
          layer.bindPopup(popupContent);
          layer.on('click', ()=>layer.setStyle({color:"yellow"}));
        }
      }).addTo(kkprLayer);
      kkprLayer.addTo(map);
    });

    // RTRW Layers
    const perlindunganLayer = L.layerGroup();
    const transportasiLayer = L.layerGroup();
    const industriLayer = L.layerGroup();

    const rtrwFiles = [
      {layer:perlindunganLayer, file:"data/Kawasan yang Memberikan Perlindungan terhadap Kawasan Bawahannya.json", color:"rgb(35,65,40)"},
      {layer:transportasiLayer, file:"data/Kawasan Transportasi.json", color:"rgb(215,55,0)"},
      {layer:industriLayer, file:"data/Kawasan Peruntukan Industri.json", color:"rgb(105,0,0)"}
    ];

    rtrwFiles.forEach(item=>{
      fetch(item.file).then(r=>r.json()).then(data=>{
        L.geoJSON(data,{
          pane: 'rtrwPane',
          style:{
            fillColor: item.color,
            fillOpacity: 1,    // solid fill
            color: item.color,
            weight: 1
          },
          onEachFeature: (feature, layer)=>{
            const p = feature.properties;
            const popupContent = `<table class="popup-table"><tr><th>Nama</th><td>${p.Nama||"-"}</td></tr></table>`;
            layer.bindPopup(popupContent);
          }
        }).addTo(item.layer);
        item.layer.addTo(map);
      });
    });

    // Toggle panel
    const toggleBtn = document.getElementById('layerToggle');
    const panel = document.getElementById('layerPanel');
    toggleBtn.addEventListener('click', ()=>panel.classList.toggle('show'));

    // Checkbox show/hide
    document.getElementById('osmLayer').addEventListener('change', e=>e.target.checked?map.addLayer(osm):map.removeLayer(osm));
    document.getElementById('satLayer').addEventListener('change', e=>e.target.checked?map.addLayer(satelit):map.removeLayer(satelit));
    document.getElementById('kkprLayer').addEventListener('change', e=>e.target.checked?map.addLayer(kkprLayer):map.removeLayer(kkprLayer));
    document.getElementById('perlindunganLayer').addEventListener('change', e=>e.target.checked?map.addLayer(perlindunganLayer):map.removeLayer(perlindunganLayer));
    document.getElementById('transportasiLayer').addEventListener('change', e=>e.target.checked?map.addLayer(transportasiLayer):map.removeLayer(transportasiLayer));
    document.getElementById('industriLayer').addEventListener('change', e=>e.target.checked?map.addLayer(industriLayer):map.removeLayer(industriLayer));

  </script>
</body>
</html>
